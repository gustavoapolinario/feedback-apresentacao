<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="firebase-app.html">
<script src="../js/login.js"></script>

<dom-module id="presentation-list-item">
    <template>
        <style is="custom-style">
        :host {
            display: block;
            margin-bottom: 16px;
        }
        :host h2 {
            color: #2196F3 !important;
            font-weight: 300;
            font-size: 1.68rem;
            line-height: 27.72px;
        }
        :host .card-actions {
            padding: 20px;
        }
        :host .inactive {
            color: #9e9e9e;
        }
        :host .active {
            color: #2196F3;
        }
        :host .active iron-icon {
            color: #F44336;
        }
        :host .fr {
            float: right;
        }
        </style>

        <firebase-auth
            id="auth"
            user="{{user}}"
            provider="google"
            on-error="errorHandler">
        </firebase-auth>
        <firebase-document id="voteDocument"
            path="/votes/[[presentation.$key]]/[[user.uid]]"
            data="{{liveVoted}}">
        </firebase-document>
        <app-indexeddb-mirror
            key="presentationList"
            data="{{liveVoted}}"
            persisted-data="{{persistedVoted}}">
        </app-indexeddb-mirror>

        <paper-card>
            <article class="card-content">
                <h2 class="blue-text flow-text">[[presentation.title]]</h2>
                <p>
                    [[presentation.description]]
                </p>
                <p>
                    por: [[presentation.author]]
                </p>
            </article>
            <div class$="card-actions {{_classVoted(this.voted)}}">
                <iron-icon icon="icons:{{_classFavoriteVoted(this.voted)}}" on-click="_vote"></iron-icon>
                <paper-button class="fr">#queroTeVerNoCiclo</paper-button>
            </div>
        </paper-card>
    </template>
    <script>
    class PresentationListItem extends Polymer.Element {
        static get is() { return 'presentation-list-item'; }
        static get properties() {
            return {
                presentation: {
                    type: Object
                },
                liveVoted: {
                    type: Object
                },
                liveVoted2: {
                    type: Object
                },
                persistedVoted: {
                    type: Object,
                    observer: 'persistedVotedChanged'
                },
                voted: {
                    type: Boolean
                },
            }
        }
        _classVoted(voted) {
            return this.voted ? 'active' : 'inactive';
        }
        _classFavoriteVoted(voted) {
            return this.voted ? 'favorite' : 'favorite-border';
        }
        constructor() {
            super();
            this.voted = 0;
            this.notifyPath('this.voted', 'changed');
        }
        _vote() {
            this.voted = this.voted ? null : 1;
            //this.persistedVoted = this.voted;
            this.liveVoted = this.persistedVoted = this.voted;
            this.notifyPath('this.voted', 'changed');
        }
        persistedVotedChanged(newData, oldData) {
            if( newData != null && newData != 'undefined' ) {
                this.voted = newData == 1 ? 1 : 0;
                this.notifyPath('this.voted', 'changed');
            }
        }
    }
    customElements.define(PresentationListItem.is, PresentationListItem);
    </script>
</dom-module>